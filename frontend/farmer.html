<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AgriMitra | Farmer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
  --green: #2d6a4f;
  --dark: #1b4332;
  --light: #d8f3dc;
  --bg: #f6fff9;
}

/* Reset */
* { box-sizing: border-box; margin:0; padding:0; }
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #222; }

/* Weather Strip */
.weather-strip { display:flex; gap:12px; align-items:center; justify-content:center; padding:8px; background:#40916c; color:#fff; font-size:14px; flex-wrap:wrap; }
.weather-pill { background: rgba(255,255,255,0.2); padding:4px 10px; border-radius:999px; font-weight:600; }

/* Navbar */
nav { display:flex; justify-content:space-between; align-items:center; background: var(--green); color:#fff; padding:12px 20px; position:relative; }
.logo { font-size:20px; font-weight:bold; }
nav ul { list-style:none; display:flex; gap:20px; margin:0; padding:0; }
nav a { color:#fff; text-decoration:none; font-weight:500; }
nav a:hover { text-decoration:underline; }
.menu-toggle { display:none; font-size:26px; cursor:pointer; }
@media(max-width:768px){
  nav ul { display:none; flex-direction:column; gap:14px; background:rgba(0,0,0,0.9); position:absolute; top:100%; left:0; width:100%; padding:18px 0; text-align:center; }
  nav ul.show { display:flex; }
  .menu-toggle { display:block; }
}

/* Layout */
.container { display:flex; padding:20px; gap:20px; max-width:1200px; margin:auto; }
.sidebar { flex:0 0 220px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); height:fit-content; }
.sidebar h3 { margin-top:0; color: var(--green); font-size:18px; margin-bottom:10px; }
.sidebar ul { list-style:none; padding:0; margin:0; }
.sidebar li { margin:10px 0; }
.sidebar a { text-decoration:none; color:#333; font-weight:500; }
.sidebar a:hover { color:var(--green); }

.main { flex:1; display:flex; flex-direction:column; gap:20px; }

/* Cards */
.card { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); transition: 0.3s; }
.card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
.card h2 { margin-top:0; color: var(--green); margin-bottom:15px; }

/* Modernized Crop Form */
#addCrop { background: linear-gradient(145deg, #d8f3dc, #f6fff9); padding: 30px 25px; border-radius: 20px; }
#cropForm { display: flex; flex-direction: column; gap: 18px; }

.crop-field { position: relative; }
.crop-field input {
  width: 100%;
  border-radius: 12px;
  padding: 14px 16px;
  border: 1px solid #b7d7c4;
  outline: none;
  background: #fff;
  font-size: 15px;
  transition: 0.3s;
}
.crop-field input:focus { border-color: #40916c; box-shadow: 0 4px 12px rgba(64,145,108,0.25); }

.crop-field label {
  position: absolute;
  top: 50%;
  left: 18px;
  transform: translateY(-50%);
  color: #888;
  font-size: 14px;
  pointer-events: none;
  transition: 0.3s;
}
.crop-field input:focus + label,
.crop-field input:not(:placeholder-shown) + label {
  top: -8px;
  font-size: 12px;
  color: #2d6a4f;
  background: #d8f3dc;
  padding: 0 6px;
  border-radius: 4px;
}

/* File input styling */
.crop-field input[type="file"] { padding: 8px; }

/* Button */
#add-btn {
  background: linear-gradient(135deg, #2d6a4f, #40916c);
  color: #fff;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  padding: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}
#add-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 15px rgba(64,145,108,0.4); }

/* Crop list */
ul.crops { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; }
ul.crops li { padding:12px; border:1px solid #eee; border-radius:8px; background:#f8fdf7; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
ul.crops li img { height:50px; width:50px; object-fit:cover; border-radius:6px; }
ul.crops span { font-weight:500; }

/* Image preview */
#cropPreview { max-width:100%; max-height:150px; border-radius:12px; margin-top:10px; display:none; object-fit:cover; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

/* Language select */
#langSelect { padding:6px; border-radius:6px; font-weight:600; margin-left:10px; }

/* Responsive */
@media(max-width:900px){ .container { flex-direction:column; } .sidebar{ flex:none; } }
@media(max-width:600px){ .card{ padding:16px; } input, button{ font-size:13px; padding:10px; } .sidebar{ padding:16px; } .sidebar h3{ font-size:16px; } }
</style>
</head>
<body>

<div class="weather-strip" id="weatherStrip"><span>Loading weather...</span></div>

<nav>
  <div class="logo">üåæ AgriMitra</div>
  <span class="menu-toggle" onclick="toggleMenu()">‚ò∞</span>
  <ul id="navbar-links"></ul>
  <select id="langSelect" onchange="changeLanguage()">
    <option value="en">English</option>
    <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
    <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
    <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
    <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
  </select>
</nav>

<div class="container">
  <div class="sidebar">
    <h3 id="menu-title">Farmer Menu</h3>
    <ul>
      <li><a href="#addCrop" id="menu-add">‚ûï Add Crop</a></li>
      <li><a href="#myCrops" id="menu-my">üå± My Crops</a></li>
      <li><a href="#insights" id="menu-insights">üìä Market Insights</a></li>
    </ul>
  </div>

  <div class="main">
    <div class="card" id="addCrop">
      <h2 id="add-title">‚ûï Add New Crop</h2>
      <form id="cropForm">
        <input type="hidden" id="editCropId">
        <div class="crop-field">
          <input type="text" id="cropName" placeholder=" " required>
          <label for="cropName">Crop Name</label>
        </div>
        <div class="crop-field">
          <input type="number" id="quantity" placeholder=" " required>
          <label for="quantity">Quantity</label>
        </div>
        <div class="crop-field">
          <input type="number" id="price" placeholder=" " required>
          <label for="price">Price per Unit (‚Çπ)</label>
        </div>
        <div class="crop-field">
          <input type="file" id="cropImage" accept="image/*">
          <label for="cropImage">Upload Image</label>
          <img id="cropPreview" alt="Preview">
        </div>
        <button type="submit" id="add-btn">Add Crop</button>
      </form>
    </div>

    <div class="card" id="myCrops">
      <h2 id="my-title">üå± My Crops</h2>
      <ul class="crops" id="cropsList"></ul>
    </div>

    <div class="card" id="insights">
      <h2 id="insights-title">üìä Market Insights</h2>
      <p id="insights-text">Coming soon: price comparison graphs, demand forecasts and more.</p>
    </div>
  </div>
</div>

<script>
const API = "http://127.0.0.1:5000";
let user = JSON.parse(localStorage.getItem("user") || "{}");
if(!user.id || user.role!=="farmer") window.location="index.html";

const translations = {
  en:{menu:"Farmer Menu", add_title:"‚ûï Add New Crop", add_btn:"Add Crop", update_btn:"Update Crop", my_title:"üå± My Crops", insights_title:"üìä Market Insights", insights_text:"Coming soon: price comparison graphs, demand forecasts and more."},
  hi:{menu:"‡§ï‡§ø‡§∏‡§æ‡§® ‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç", add_title:"‚ûï ‡§®‡§à ‡§´‡§∏‡§≤ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç", add_btn:"‡§ú‡•ã‡§°‡§º‡•á‡§Ç", update_btn:"‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç", my_title:"üå± ‡§Æ‡•á‡§∞‡•Ä ‡§´‡§∏‡§≤‡•á‡§Ç", insights_title:"üìä ‡§Æ‡§æ‡§∞‡•ç‡§ï‡•á‡§ü ‡§á‡§®‡§∏‡§æ‡§á‡§ü‡•ç‡§∏", insights_text:"‡§ú‡§≤‡•ç‡§¶ ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•à: ‡§ï‡•Ä‡§Æ‡§§ ‡§§‡•Å‡§≤‡§®‡§æ ‡§ó‡•ç‡§∞‡§æ‡§´‡§º, ‡§Æ‡§æ‡§Ç‡§ó ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§®‡•Å‡§Æ‡§æ‡§® ‡§î‡§∞ ‡§Ö‡§ß‡§ø‡§ï‡•§"},
  ta:{menu:"‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ‡Æø ‡ÆÆ‡ØÜ‡Æ©‡ØÅ", add_title:"‚ûï ‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç", add_btn:"‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç", update_btn:"‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç", my_title:"üå± ‡Æé‡Æ©‡Øç ‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç‡Æï‡Æ≥‡Øç", insights_title:"üìä ‡Æö‡Æ®‡Øç‡Æ§‡Øà ‡ÆÖ‡Æ±‡Æø‡Æµ‡ØÅ‡Æ∞‡Øà‡Æï‡Æ≥‡Øç", insights_text:"‡Æµ‡Æø‡Æ∞‡Øà‡Æµ‡Æø‡Æ≤‡Øç: ‡Æµ‡Æø‡Æ≤‡Øà ‡Æí‡Æ™‡Øç‡Æ™‡ØÄ‡Æü‡ØÅ ‡Æµ‡Æ∞‡Øà‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç, ‡Æ§‡Øá‡Æµ‡Øà‡Æï‡Øç ‡Æï‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡Øá‡Æ≤‡ØÅ‡ÆÆ‡Øç."},
  te:{menu:"‡∞∞‡±à‡∞§‡±Å ‡∞Æ‡±Ü‡∞®‡±Ç", add_title:"‚ûï ‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞™‡∞Ç‡∞ü ‡∞ö‡±á‡∞∞‡±ç‡∞ö‡±Å", add_btn:"‡∞ö‡±á‡∞∞‡±ç‡∞ö‡±Å", update_btn:"‡∞®‡∞µ‡±Ä‡∞ï‡∞∞‡∞ø‡∞Ç‡∞ö‡±Å", my_title:"üå± ‡∞®‡∞æ ‡∞™‡∞Ç‡∞ü‡∞≤‡±Å", insights_title:"üìä ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞æ‡∞≤‡±Å", insights_text:"‡∞ö‡∞ø‡∞®‡±ç‡∞® ‡∞ï‡∞æ‡∞≤‡∞Ç‡∞≤‡±ã: ‡∞ß‡∞∞‡∞≤ ‡∞∏‡∞∞‡∞ø‡∞™‡±ã‡∞≤‡∞ø‡∞ï ‡∞ó‡±ç‡∞∞‡∞æ‡∞´‡±ç‚Äå‡∞≤‡±Å, ‡∞°‡∞ø‡∞Æ‡∞æ‡∞Ç‡∞°‡±ç ‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ‡∞≤‡±Å ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞Æ‡∞∞‡∞ø‡∞®‡±ç‡∞®‡∞ø."},
  kn:{menu:"‡≤∞‡≥à‡≤§ ‡≤Æ‡≥Ü‡≤®‡≥Å", add_title:"‚ûï ‡≤π‡≥ä‡≤∏ ‡≤¨‡≥Ü‡≤≥‡≥Ü ‡≤∏‡≥á‡≤∞‡≤ø‡≤∏‡≤ø", add_btn:"‡≤∏‡≥á‡≤∞‡≤ø‡≤∏‡≤ø", update_btn:"‡≤®‡≤µ‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø", my_title:"üå± ‡≤®‡≤®‡≥ç‡≤® ‡≤¨‡≥Ü‡≤≥‡≥Ü‡≤ó‡≤≥‡≥Å", insights_title:"üìä ‡≤Æ‡≤æ‡≤∞‡≥Å‡≤ï‡≤ü‡≥ç‡≤ü‡≥Ü ‡≤Æ‡≤æ‡≤π‡≤ø‡≤§‡≤ø", insights_text:"‡≤¨‡≤ó‡≥ç‡≤ó‡≥Ü ‡≤¨‡≤∞‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü: ‡≤¨‡≥Ü‡≤≤‡≥Ü ‡≤π‡≥ã‡≤≤‡≤ø‡≤ï‡≥Ü ‡≤ó‡≥ç‡≤∞‡≤æ‡≤´‡≥ç‚Äå‡≤ó‡≤≥‡≥Å, ‡≤¨‡≥á‡≤°‡≤ø‡≤ï‡≥Ü‡≤Ø ‡≤Ö‡≤Ç‡≤¶‡≤æ‡≤ú‡≥Å ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤á‡≤®‡≥ç‡≤®‡≤∑‡≥ç‡≤ü‡≥Å."}
};

let lang = localStorage.getItem("lang") || "en";

function applyTranslations(){
  const L = translations[lang];
  document.getElementById("langSelect").value = lang;
  document.getElementById("menu-title").textContent = L.menu;
  document.getElementById("add-title").textContent = L.add_title;
  document.getElementById("add-btn").textContent = L.add_btn;
  document.getElementById("my-title").textContent = L.my_title;
  document.getElementById("insights-title").textContent = L.insights_title;
  document.getElementById("insights-text").textContent = L.insights_text;
  renderNavbar();
}

function changeLanguage(){ lang=document.getElementById("langSelect").value; localStorage.setItem("lang", lang); applyTranslations(); }
function toggleMenu(){ document.getElementById("navbar-links").classList.toggle("show"); }
function renderNavbar(){ 
  const nav = document.getElementById("navbar-links");
  nav.innerHTML = `<li><a href="index.html">Home</a></li><li><a href="marketplace.html">Marketplace</a></li><li><a href="equipment.html">Equipment</a></li><li><a href="#" onclick="logout()">Logout</a></li>`;
}
function logout(){ localStorage.removeItem("user"); window.location="index.html"; }

// Crop form submit
document.getElementById("cropForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const cropId = document.getElementById("editCropId").value;
  const formData = new FormData();
  
  formData.append("farmer_id", user.id);
  formData.append("crop_name", document.getElementById("cropName").value);
  formData.append("quantity", +document.getElementById("quantity").value);
  formData.append("price", +document.getElementById("price").value);
  
  const imgFile = document.getElementById("cropImage").files[0];
  if(imgFile){
    formData.append("image", imgFile);
  } else if (cropId && cropPreview.src) {
    formData.append("image_url", cropPreview.src.split('/').pop());
  }

  let url = API + "/crops"; 
  let method = "POST";
  
  if(cropId){
    url += `/${cropId}`;
    method = "PUT";
  }

  try{
    const res = await fetch(url, { method, body: formData });
    const data = await res.json();
    alert(data.message || data.error);
    resetForm();
    loadCrops();
  }catch(err){
    alert("Error: " + err);
  }
});

function resetForm(){
  document.getElementById("cropForm").reset();
  document.getElementById("editCropId").value="";
  cropPreview.style.display="none";
  document.getElementById("add-btn").textContent=translations[lang].add_btn;
}

// Load crops
async function loadCrops(){
  const res = await fetch(API+"/crops?farmer_id="+user.id);
  const crops = await res.json();
  const list = document.getElementById("cropsList");
  list.innerHTML = crops.map(c=>`
    <li data-id="${c.id}">
      ${c.image_url?`<img src="${API}/${c.image_url}">`:''}
      <span>${c.crop_name} - ${c.quantity} units @ ‚Çπ${c.price}</span>
      <div style="margin-left:auto; display:flex; gap:6px; flex-wrap:wrap;">
        <button onclick="editCrop(${c.id})" style="padding:4px 8px; background:#40916c; color:#fff; border:none; border-radius:6px; cursor:pointer;">Edit</button>
        <button onclick="deleteCrop(${c.id})" style="padding:4px 8px; background:#e63946; color:#fff; border:none; border-radius:6px; cursor:pointer;">Delete</button>
      </div>
    </li>
  `).join("");
}

// Edit crop
async function editCrop(id){
  const res = await fetch(API+"/crops/"+id);
  const c = await res.json();
  document.getElementById("cropName").value=c.crop_name;
  document.getElementById("quantity").value=c.quantity;
  document.getElementById("price").value=c.price;
  document.getElementById("editCropId").value=c.id;
  if(c.image_url){ cropPreview.src=API+"/"+c.image_url; cropPreview.style.display="block"; }
  document.getElementById("add-btn").textContent = translations[lang].update_btn;
  window.location="#addCrop";
}

// Delete crop
async function deleteCrop(id){
  if(confirm("Are you sure you want to delete this crop?")){
    const res = await fetch(API+"/crops/"+id, {method:"DELETE"});
    const data = await res.json();
    alert(data.message||data.error);
    loadCrops();
  }
}

// Image preview
const cropImageInput = document.getElementById('cropImage');
const cropPreview = document.getElementById('cropPreview');
cropImageInput.addEventListener('change', () => {
  const file = cropImageInput.files[0];
  if(file){ cropPreview.src = URL.createObjectURL(file); cropPreview.style.display="block"; } 
  else { cropPreview.style.display = "none"; }
});

// Weather
async function loadWeather(){
  const el = document.getElementById('weatherStrip');
  try{
    const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej));
    const {latitude:lat,longitude:lon}=pos.coords;
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
    const j=await r.json(); const w=j.current_weather;
    el.innerHTML=`<span class="weather-pill">üå°Ô∏è ${Math.round(w.temperature)}¬∞C</span>
                  <span class="weather-pill">üí® ${w.windspeed} km/h</span>`;
  }catch(e){ el.innerHTML="<span>Weather unavailable</span>"; }
}

applyTranslations();
loadCrops();
loadWeather();
</script>
</body>
</html>
